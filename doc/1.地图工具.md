# 地图工具

**包名**：`map_tools`

**节点名**：

* `map_loader`：地图导入节点

  **功能**：从`nav2_map_server`获取地图数据，处理地图数据并发布

  **输入**：

  | 数据名 |               数据描述                |            数据类型            |  订阅  |
  | :----: | :-----------------------------------: | :----------------------------: | :----: |
  | `msg`  | 静态地图文件，由`nav2_map_server`提供 | `nav_msgs::msg::OccupancyGrid` | `/map` |

  **输出**：

  |     数据名      | 数据描述 |            数据类型            |       发布       |
  | :-------------: | :------: | :----------------------------: | :--------------: |
  | `processed_map` | 地图文件 | `nav_msgs::msg::OccupancyGrid` | `/processed_map` |

* `pose_bridge_node`:

  **功能**：起点桥接节点，起点和终点的输入是用Rviz中的`2D pose estimate`和`2D Goal pose`，他们的类型分别是`geometry_msgs/msg/PoseWithCovarianceStamped`和 `geometry_msgs/msg/PoseStamped`，为了保持规划器中起点和终点的一致性，所以选择使用一个桥接节点，将起点的类型转换成和终点一样的类型

  **输入**：

  | 数据名 |                  数据描述                  |                    数据类型                     |      订阅      |
  | :----: | :----------------------------------------: | :---------------------------------------------: | :------------: |
  | `msg`  | 从Rviz中的`2D pose estimate`传入的坐标数据 | `geometry_msgs::msg::PoseWithCovarianceStamped` | `/initialpose` |

  **输出**：

  |  数据名   |       数据描述       |            数据类型             |      发布      |
  | :-------: | :------------------: | :-----------------------------: | :------------: |
  | `out_msg` | 更改类型后的坐标数据 | `geometry_msgs/msg/PoseStamped` | `/start_point` |



**`launch`文件**

`map_loader.launch.py`

* 地图源文件路径：`map_loader/maps/map.yaml`
* `map_server`节点：ROS自带的读取地图文件文件的节点
* `lifecycle_manager_map`节点：`map_server`的生命周期管理节点，需要该节点才能激活`map_server`
* `map_loader`节点：地图导入节点
  1. 从`map_server`订阅地图数据
  2. 处理数据
  3. 将处理好的地图数据发布
* `pose_bridge_node`节点：起点桥接节点



**参考**：

1. **关于`map_server`启动默认不激活，激活后Rviz和`ros2 topic echo`不显示话题内容的问题**

   [【ROS2 核心知识】关于lifecycle_node和话题QoS profile的扩展和杂谈-- nav2_map_server的配置](https://blog.csdn.net/m0_73800387/article/details/143452281)



**问题**：

1. 在参考项目中，地图数据会用一个双端对列保存，查看后续的处理代码，也只会拿出一次的地图来处理，这个地方不知道为什么？

2. 关于话题发布的QoS策略

   | 特性               | `volatile` | `transient_local`   |
   | :----------------- | :--------- | :------------------ |
   | 历史消息保留       | ❌ 不保留   | ✅ 保留（根据depth） |
   | 新订阅者获取旧消息 | ❌ 不可能   | ✅ 自动获取          |
   | 内存占用           | 最低       | 较高（需缓存消息）  |
   | 适用场景           | 实时数据流 | 配置/状态/地图数据  |
   | 发布者退出影响     | 无遗留数据 | 缓存消息丢失        |

